<?php
/**
 * Manage Bookings - Admin
 * Classroom Resource Booking System
 */

require_once '../config/config.php';
requireAdmin();

$conn = getDBConnection();

// Handle booking approval/rejection
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['approve_booking'])) {
        $booking_id = intval($_POST['booking_id']);
        $admin_notes = sanitizeInput($conn, $_POST['admin_notes'] ?? '');
        
        $sql = "UPDATE bookings SET status = 'approved', admin_notes = ?, approved_by = ?, approved_at = NOW() WHERE booking_id = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("sii", $admin_notes, $_SESSION['user_id'], $booking_id);
        
        if ($stmt->execute()) {
            setFlashMessage('Booking approved successfully!', 'success');
        }
        $stmt->close();
    } elseif (isset($_POST['reject_booking'])) {
        $booking_id = intval($_POST['booking_id']);
        $admin_notes = sanitizeInput($conn, $_POST['admin_notes'] ?? '');
        
        $sql = "UPDATE bookings SET status = 'rejected', admin_notes = ?, approved_by = ?, approved_at = NOW() WHERE booking_id = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("sii", $admin_notes, $_SESSION['user_id'], $booking_id);
        
        if ($stmt->execute()) {
            setFlashMessage('Booking rejected.', 'warning');
        }
        $stmt->close();
    }
    
    redirect(SITE_URL . '/admin/manage_bookings.php');
}

// Handle booking deletion
if (isset($_GET['delete']) && is_numeric($_GET['delete'])) {
    $booking_id = intval($_GET['delete']);
    
    $sql = "DELETE FROM bookings WHERE booking_id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $booking_id);
    
    if ($stmt->execute()) {
        setFlashMessage('Booking deleted successfully!', 'success');
    } else {
        setFlashMessage('Failed to delete booking.', 'error');
    }
    $stmt->close();
    
    redirect(SITE_URL . '/admin/manage_bookings.php');
}

// Get filter
$filter = isset($_GET['filter']) ? $_GET['filter'] : 'all';

// Build query based on filter
$where_clause = '';
if ($filter !== 'all') {
    $where_clause = "WHERE b.status = '$filter'";
}

// Get all bookings
$sql = "SELECT b.*, u.full_name, u.email, u.phone, r.resource_name, r.resource_code
        FROM bookings b
        JOIN users u ON b.user_id = u.user_id
        JOIN resources r ON b.resource_id = r.resource_id
        $where_clause
        ORDER BY b.booking_date DESC, b.start_time DESC";
$bookings_result = executeQuery($conn, $sql);

// Store bookings in array for use in both table and modals
$bookings_array = [];
if ($bookings_result && $bookings_result->num_rows > 0) {
    while ($row = $bookings_result->fetch_assoc()) {
        $bookings_array[] = $row;
    }
}

$page_title = 'Manage Bookings';
include '../includes/header.php';
?>

<style>
/* Fix modal blinking issue by disabling fade animations */
.modal {
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.show {
    display: block;
}

.modal-backdrop {
    display: none;
    background-color: #000;
    opacity: 0.5;
}

.modal-backdrop.show {
    display: block;
}

/* Prevent body scrolling when modal is open */
body.modal-open {
    overflow: hidden;
    padding-right: 0 !important;
}
</style>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-check"></i> Manage Bookings</h2>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link <?php echo $filter === 'all' ? 'active' : ''; ?>" href="?filter=all">
                All Bookings
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link <?php echo $filter === 'pending' ? 'active' : ''; ?>" href="?filter=pending">
                Pending
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link <?php echo $filter === 'approved' ? 'active' : ''; ?>" href="?filter=approved">
                Approved
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link <?php echo $filter === 'rejected' ? 'active' : ''; ?>" href="?filter=rejected">
                Rejected
            </a>
        </li>
    </ul>

    <div class="card">
        <div class="card-body">
            <?php if (count($bookings_array) > 0): ?>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Resource</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Purpose</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($bookings_array as $booking): ?>
                        <tr>
                            <td>#<?php echo $booking['booking_id']; ?></td>
                            <td>
                                <?php echo htmlspecialchars($booking['full_name']); ?><br>
                                <small class="text-muted"><?php echo htmlspecialchars($booking['email']); ?></small>
                            </td>
                            <td>
                                <strong><?php echo htmlspecialchars($booking['resource_code']); ?></strong><br>
                                <small><?php echo htmlspecialchars($booking['resource_name']); ?></small>
                            </td>
                            <td><?php echo formatDate($booking['booking_date']); ?></td>
                            <td>
                                <?php echo formatTime($booking['start_time']); ?><br>
                                <small>to <?php echo formatTime($booking['end_time']); ?></small>
                            </td>
                            <td><?php echo htmlspecialchars(substr($booking['purpose'], 0, 50)) . '...'; ?></td>
                            <td>
                                <span class="badge <?php echo getBookingStatusBadge($booking['status']); ?>">
                                    <?php echo ucfirst($booking['status']); ?>
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#viewModal<?php echo $booking['booking_id']; ?>" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <?php if ($booking['status'] === 'pending'): ?>
                                <button class="btn btn-sm btn-success" data-toggle="modal" data-target="#approveModal<?php echo $booking['booking_id']; ?>" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#rejectModal<?php echo $booking['booking_id']; ?>" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                                <?php endif; ?>
                                <a href="?delete=<?php echo $booking['booking_id']; ?>" class="btn btn-sm btn-danger confirm-delete" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <!-- Modals for each booking -->
            <?php 
            foreach ($bookings_array as $booking): 
            ?>
            
            <!-- View Modal -->
            <div class="modal" id="viewModal<?php echo $booking['booking_id']; ?>" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel<?php echo $booking['booking_id']; ?>" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewModalLabel<?php echo $booking['booking_id']; ?>">Booking Details #<?php echo $booking['booking_id']; ?></h5>
                            <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-borderless">
                                <tr><th>User:</th><td><?php echo htmlspecialchars($booking['full_name']); ?></td></tr>
                                <tr><th>Email:</th><td><?php echo htmlspecialchars($booking['email']); ?></td></tr>
                                <tr><th>Phone:</th><td><?php echo htmlspecialchars($booking['phone']); ?></td></tr>
                                <tr><th>Resource:</th><td><?php echo htmlspecialchars($booking['resource_name']); ?> (<?php echo htmlspecialchars($booking['resource_code']); ?>)</td></tr>
                                <tr><th>Date:</th><td><?php echo formatDate($booking['booking_date']); ?></td></tr>
                                <tr><th>Time:</th><td><?php echo formatTime($booking['start_time']) . ' - ' . formatTime($booking['end_time']); ?></td></tr>
                                <tr><th>Attendees:</th><td><?php echo $booking['attendees']; ?></td></tr>
                                <tr><th>Purpose:</th><td><?php echo htmlspecialchars($booking['purpose']); ?></td></tr>
                                <tr><th>Status:</th><td><span class="badge <?php echo getBookingStatusBadge($booking['status']); ?>"><?php echo ucfirst($booking['status']); ?></span></td></tr>
                                <?php if (!empty($booking['admin_notes'])): ?>
                                <tr><th>Admin Notes:</th><td><?php echo htmlspecialchars($booking['admin_notes']); ?></td></tr>
                                <?php endif; ?>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approve Modal -->
            <div class="modal" id="approveModal<?php echo $booking['booking_id']; ?>" tabindex="-1" role="dialog" aria-labelledby="approveModalLabel<?php echo $booking['booking_id']; ?>" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <form method="POST">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="approveModalLabel<?php echo $booking['booking_id']; ?>">Approve Booking #<?php echo $booking['booking_id']; ?></h5>
                                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="booking_id" value="<?php echo $booking['booking_id']; ?>">
                                <div class="form-group">
                                    <label>Admin Notes (Optional)</label>
                                    <textarea class="form-control" name="admin_notes" rows="3" placeholder="Add any notes..."></textarea>
                                </div>
                                <p>Are you sure you want to approve this booking?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" name="approve_booking" class="btn btn-success">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reject Modal -->
            <div class="modal" id="rejectModal<?php echo $booking['booking_id']; ?>" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel<?php echo $booking['booking_id']; ?>" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <form method="POST">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title" id="rejectModalLabel<?php echo $booking['booking_id']; ?>">Reject Booking #<?php echo $booking['booking_id']; ?></h5>
                                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="booking_id" value="<?php echo $booking['booking_id']; ?>">
                                <div class="form-group">
                                    <label class="required">Rejection Reason</label>
                                    <textarea class="form-control" name="admin_notes" rows="3" placeholder="Please specify reason for rejection..." required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="submit" name="reject_booking" class="btn btn-danger">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php else: ?>
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h4>No Bookings Found</h4>
                <p>No bookings match the selected filter.</p>
            </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<script>
// Fix modal flickering by disabling animations
$(document).ready(function() {
    // Remove fade class to eliminate blinking
    $('.modal').removeClass('fade');
    
    // Use direct show/hide without animations
    $(document).on('click', '[data-toggle="modal"]', function() {
        var target = $(this).data('target');
        $(target).show();
        $(target).addClass('show');
        $('body').addClass('modal-open');
        $('.modal-backdrop').remove();
        $('body').append('<div class="modal-backdrop show"></div>');
    });
    
    // Handle close buttons
    $(document).on('click', '[data-dismiss="modal"]', function() {
        $(this).closest('.modal').removeClass('show');
        $(this).closest('.modal').hide();
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
    });
});
</script>

<?php closeDBConnection($conn); ?>
<?php include '../includes/footer.php'; ?>
